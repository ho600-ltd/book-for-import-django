初始化 django-based 專案
-------------------------------------------------------------------------------

.. code-block:: sh

    $ virtualenv -p python3 --no-site-packages restful_api_site.py3env
    $ source restful_api_site.py3env/bin/activate \
    # In PowerShell: \
    # PS C:\> restful_api_site.py3env\scripts\activate
    (restful_api_site.py3env) $ pip install "Django>2.2,<2.3"
    ...
    Successfully installed Django-2.2.9 sqlparse-0.3.0
    (restful_api_site.py3env) $ django-admin startproject restful_api_site

restful_api_site 專案從無到初始化的程式碼差異比對: \
`cc69bfb <https://github.com/ho600-ltd/examples-of-book-for-import-django/commit/cc69bfb98c16ffcb72d36dd15f23d0ccb72d9cf4>`_

.. code-block:: sh

    (restful_api_site.py3env) $ cd restful_api_site
    (restful_api_site.py3env) restful_api_site/ $ ls
    manage.py        restful_api_site
    (restful_api_site.py3env) restful_api_site/ $ git init && git add . && git ci -m '...'
    ...
    [master cc69bfb] ...
    5 files changed, 126 insertions(+)
    create mode 100644 ...
    (restful_api_site.py3env) restful_api_site/ $ git di cc69bfb^..cc69bfb --name-only
    restful_api_site/manage.py
    restful_api_site/restful_api_site/__init__.py
    restful_api_site/restful_api_site/settings.py
    restful_api_site/restful_api_site/urls.py
    restful_api_site/restful_api_site/wsgi.py

程式檔說明:

* manage.py: 在本地端開發時，用以執行一個 http deamon 的執行檔
* __init__.py: 為一空內容的純文字檔，置於第二層的 restful_api_site/ 中，\
這樣第二層的 resuful_api_site 可視為一個 module 
* settings.py: 專案的基本設定檔
* urls.py: 當 restful_api_site 運作在 http deamon 或 WSGI deamon 上， \
urls.py 可載明進入的 url path 為何? 並對應到那些 view function
* wsgi.py: 給 WSGI server 的進入點，讓 restful_api_site 運作在 WSGI server 上

.. code-block:: sh

    (restful_api_site.py3env) restful_api_site/ $ git di cc69bfb^..cc69bfb restful_api_site/settings.py

.. code-block:: diff

    diff --git a/restful_api_site/restful_api_site/settings.py b/restful_api_site/restful_api_site/settings.py
    new file mode 100644
    index 0000000..5a8707d
    --- /dev/null
    +++ b/restful_api_site/restful_api_site/settings.py
    @@ -0,0 +1,120 @@
    +"""
    +Django settings for restful_api_site project.
    +Generated by 'django-admin startproject' using Django 2.2.9.
    ...
    +"""
    ...
    +ROOT_URLCONF = 'restful_api_site.urls'
    ...
    +WSGI_APPLICATION = 'restful_api_site.wsgi.application'
    +DATABASES = {
    +    'default': {
    +        'ENGINE': 'django.db.backends.sqlite3',
    +        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),
    +    }
    +}
    ...
    +LANGUAGE_CODE = 'en-us'
    +TIME_ZONE = 'UTC'
    +USE_I18N = True
    +USE_L10N = True
    +USE_TZ = True
    +STATIC_URL = '/static/'

此修改版本的 settings.py 內容可到 Github \
的 `restful_api_site/restful_api_site/settings.py(cc69bfb9 commit) <https://github.com/ho600-ltd/examples-of-book-for-import-django/commit/cc69bfb98c16ffcb72d36dd15f23d0ccb72d9cf4#diff-21a51302934f25442a0bd16766f498df>`_ \
瀏覽。

在目前這個階段， restful_api_site 是一個擁有 django 預設功能的網站，\
而資料庫管理系統上預設是用 sqlite3 ，其設定方式在 settings.py :

.. code-block:: python

    # settings.py
    DATABASES = {
        'default': {
            'ENGINE': 'django.db.backends.sqlite3',
            'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),
        }
    }

運作網站的第一步是要建立資料庫結構:

.. code-block:: sh

    (restful_api_site.py3env) restful_api_site/ $ ./manage.py migrate
    Operations to perform:
      Apply all migrations: admin, auth, contenttypes, sessions
    Running migrations:
      Applying contenttypes.0001_initial... OK
      Applying auth.0001_initial... OK
      Applying admin.0001_initial... OK
      ...
      Applying contenttypes.0002_remove_content_type_name... OK
      ...
      Applying sessions.0001_initial... OK

運作本地端 http deamon:

.. code-block:: sh

    (restful_api_site.py3env) restful_api_site/ $ ./manage.py runserver
    ...
    January 17, 2020 - 03:35:27
    Django version 2.2.9, using settings 'restful_api_site.settings'
    Starting development server at http://127.0.0.1:8000/
    Quit the server with CONTROL-C.

瀏覽器觀看成果如下:

.. figure:: 01part/default_index.png
    :align: center
    :width: 600px

    因為 settings.LANGUAGE_CODE = "en-us" ，所以網頁是英文的

接下來，我們修改 settings.LANGUAGE_CODE 及 settings.DATABASES['default'] ，\
讓語言預設是使用正體中文、資料庫則是改用 MariaDB :

.. code-block:: sh

    (restful_api_site.py3env) restful_api_site/ $ git di

.. code-block:: diff

    diff --git a/restful_api_site/restful_api_site/settings.py b/restful_api_site/restful_api_site/settings.py
    index 5a8707d..d7f9a35 100644
    --- a/restful_api_site/restful_api_site/settings.py
    +++ b/restful_api_site/restful_api_site/settings.py
    @@ -75,8 +75,16 @@ WSGI_APPLICATION = 'restful_api_site.wsgi.application'
    
    DATABASES = {
        'default': {
    -        'ENGINE': 'django.db.backends.sqlite3',
    -        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),
    +        'ENGINE': 'django.db.backends.mysql',
    +        'NAME': 'restful_api_site',
    +        'USER': 'restful_api_site',
    +        'PASSWORD': 'restful_api_site_pw',
    +        'HOST': 'my.mariadb.host',
    +        'PORT': '3306',
    +        'OPTIONS': {
    +        },
        }
    }
    ...
    -LANGUAGE_CODE = 'en-us'
    +LANGUAGE_CODE = 'zh-Hant'

本次修改詳見 `ca533439 <https://github.com/ho600-ltd/examples-of-book-for-import-django/commit/ca533439e1c9e3f2edc8c5fb223ebfe063e60773>`_ 。

設定 MariaDB 的資料庫名、使用者帳號、密碼、權限如下:

.. code-block:: sh

    $ mysql -h my.mariadb.host -u root -p
    MariaDB [(none)]> CREATE DATABASE restful_api_site CHARACTER SET utf8mb4 DEFAULT COLLATE utf8mb4_unicode_ci;
    MariaDB [(none)]> create user 'restful_api_site'@'%' identified by 'restful_api_site_pw';
    MariaDB [(none)]> GRANT ALL PRIVILEGES on restful_api_site.* to restful_api_site@'%';
    MariaDB [(none)]> \q

並為這個 restful_api_site 專案安裝 MariaDB driver(mysqlclient) ，\
首先我們把套件紀錄到 restful_api_site/requirements.txt :

.. code-block:: text

    # requirements.txt
    Django>=2.2,<2.3
    mysqlclient==1.4.5

再使用 pip 安裝它:

.. code-block:: sh

    (restful_api_site.py3env) restful_api_site/ $ pip install -r requirements.txt
    ...
    Successfully installed mysqlclient-1.4.5
    (restful_api_site.py3env) restful_api_site/ $ \
    ls ../restful_api_site.py3env/lib/python3.7/site-packages/mysqlclient-1.4.5.dist-info
    INSTALLER     LICENSE       METADATA      RECORD        WHEEL         top_level.txt

再作一次資料表生成:

.. code-block:: sh

    (restful_api_site.py3env) restful_api_site/ $ ./manage.py migrate
    Operations to perform:
      Apply all migrations: admin, auth, contenttypes, sessions
    Running migrations:
      Applying contenttypes.0001_initial... OK
      Applying auth.0001_initial... OK
      Applying admin.0001_initial... OK
      ...
      Applying contenttypes.0002_remove_content_type_name... OK
      ...
      Applying sessions.0001_initial... OK

再次運作本地端 http deamon ，即可在瀏覽器中見到如下:

.. figure:: 01part/zh_hant_index.png
    :align: center
    :width: 600px

到本階段為止，範例程式碼的進度在 \
`76c5dd81 <https://github.com/ho600-ltd/examples-of-book-for-import-django/commit/76c5dd8180e115124c26e0c911dfae27670749b1>`_ 。